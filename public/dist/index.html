<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapa Tibia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container-fluid {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #map-container {
            flex: 1;
            width: 100%;
            height: 70vh;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #inputs-container {
            background-color: #1c1c1c;
            padding: 20px;
            color: #e0e0e0;
        }
        .form-control, .btn-primary {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border-color: #444;
        }
        .form-control:focus {
            background-color: #3c3c3c;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #3c3c3c;
            border-color: #555;
        }
        .city-btn {
            margin: 5px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border-color: #444;
        }
        .city-btn:hover {
            background-color: #3c3c3c;
            color: #ffffff;
        }
    </style>	  
</head>
<body>

<div class="container-fluid">
    <div class="row flex-grow-1">
        <div class="col-12 p-0" id="map-container">
            <div id="map"></div>
        </div>
    </div>
    <div class="row" id="inputs-container">
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label for="exiva">Insira o exiva dos personagens:</label>
                <textarea class="form-control" id="exiva" rows="4"></textarea>
            </div>
            <button type="button" class="btn btn-primary mb-3 w-100" id="processExiva">Processar Exiva</button>
        </div>
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label for="results">Resultados:</label>
                <textarea class="form-control" id="results" rows="4" readonly></textarea>
            </div>
        </div>
        <div class="col-md-4">
            <h5 class="mb-3">Cidades</h5>
            <div id="city-buttons" class="d-flex flex-wrap justify-content-start">
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="dist/map.js"></script>
<script>

function initializeMap() {
    console.log('Iniciando inicialização do mapa');
    if (typeof window.tibiaMap === 'undefined') {
        console.error('window.tibiaMap não está definido');
        return;
    }
    if (!window.tibiaMap.map) {
        console.error('window.tibiaMap.map não está definido');
        return;
    }
    console.log('window.tibiaMap está definido corretamente');

    createCityButtons();

    const processExivaButton = document.getElementById('processExiva');
    if (processExivaButton) {
        processExivaButton.addEventListener('click', processExiva);
        console.log('Evento de clique adicionado ao botão de processar Exiva');
    } else {
        console.error('Botão de processar Exiva não encontrado');
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'e' || event.key === 'E') {
            processExiva();
        }
    });
    console.log('Evento de tecla E adicionado');

    window.tibiaMap.map.on('click', function(event) {
        const direction = determineDirection(event);
        findHuntAreas(direction);
    });
    console.log('Evento de clique adicionado ao mapa');

    console.log('Todos os eventos foram inicializados');
}

window.addEventListener('htmlContentLoaded', function() {
    console.log('Evento htmlContentLoaded disparado');
    initializeMap();
});


function findHuntAreas(direction) {
    const map = window.tibiaMap.map;
    const bounds = map.getBounds();
    const center = map.getCenter();
    
    const relevantAreas = window.huntAreas.filter(area => {
        const areaLatLng = map.unproject([area.x, area.y], 0);
        const areaDirection = determineDirection({latlng: areaLatLng});
        return areaDirection === direction;
    });

    const visibleAreas = relevantAreas.filter(area => 
        bounds.contains(map.unproject([area.x, area.y], 0))
    );

    const invisibleAreas = relevantAreas.filter(area => 
        !bounds.contains(map.unproject([area.x, area.y], 0))
    );

    let resultText = "";
    if (visibleAreas.length > 0) {
        resultText += "Áreas visíveis: " + visibleAreas.map(area => area.name).join(", ") + "\n\n";
    }
    if (invisibleAreas.length > 0) {
        resultText += "Áreas fora da visão: " + invisibleAreas.map(area => area.name).join(", ");
    }
    
    if (resultText === "") {
        resultText = "Nenhuma área de caça encontrada nessa direção.";
    }

    document.getElementById('results').value = resultText;
}

function determineDirection(event) {
    const map = window.tibiaMap.map; 
    const center = map.getCenter();
    const clickPoint = event.latlng;
    
    const dx = clickPoint.lng - center.lng;
    const dy = clickPoint.lat - center.lat;
    
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    
    if (angle > -22.5 && angle <= 22.5) return "East";
    if (angle > 22.5 && angle <= 67.5) return "North-east";
    if (angle > 67.5 && angle <= 112.5) return "North";
    if (angle > 112.5 && angle <= 157.5) return "North-west";
    if (angle > 157.5 || angle <= -157.5) return "West";
    if (angle > -157.5 && angle <= -112.5) return "South-west";
    if (angle > -112.5 && angle <= -67.5) return "South";
    if (angle > -67.5 && angle <= -22.5) return "South-east";
}

function createCityButtons() {
    const cityButtonsContainer = document.getElementById('city-buttons');
    if (!cityButtonsContainer) {
        console.error('Container de botões de cidade não encontrado');
        return;
    }

    cityButtonsContainer.innerHTML = '';

    if (Array.isArray(window.cityAreas) && window.cityAreas.length > 0) {
        window.cityAreas.forEach(city => {
            const button = document.createElement('button');
            button.textContent = city.name;
            button.className = 'btn btn-sm btn-outline-light city-btn';
            button.onclick = function() {
                console.log(`Movendo para ${city.name}: x=${city.x}, y=${city.y}, floor=${city.floor}`);
                if (window.tibiaMap && window.tibiaMap.map) {
                    window.tibiaMap.map.setView([city.y, city.x], 0);
                } else {
                    console.error('Mapa não está disponível');
                }
            };
            cityButtonsContainer.appendChild(button);
        });
    } else {
        console.error('window.cityAreas não está definido ou está vazio');
    }
}

function processExiva() {
    console.log('Processando Exiva');
    const exivaText = document.getElementById('exiva').value;
    const direction = exivaText.match(/to the (\w+(-\w+)?)\./);
    
    if (direction) {
        const directionStr = direction[1].charAt(0).toUpperCase() + direction[1].slice(1);
        findHuntAreas(directionStr);
    } else {
        document.getElementById('results').value = "Direção não encontrada no exiva.";
    }
}
console.log('Script HTML carregado completamente');
</script>
</body>
</html>

    